<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">

  <meta name="description" content="An app store for open source apps, developed and maintained by Double Dot Labs.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="generator" content="DDStore" />
	<title>DDStore Console</title>

	<meta name="theme-color" content="#FFFFFF">
  <meta name="mobile-web-app-capable" content="yes">
  <!-- <link rel="manifest" href="manifest.json"> -->

  <meta name="application-name" content="DDStore">
  <meta name="msapplication-TileColor" content="#FFFFFF">
  <meta name="msapplication-tooltip" content="DDStore">
  <!-- <meta name="msapplication-config" content="/ieconfig.xml"> -->

	<!-- <link rel="shortcut icon" href="/favicon.ico">
  <link rel="icon" sizes="16x16" href="/favicon.ico">
  <link rel="icon" sizes="24x24" href="/images/favicon-24.ico">
  <link rel="icon" sizes="32x32" href="/images/favicon-32.ico">
  <link rel="icon" sizes="48x48" href="/images/favicon-48.ico">
  <link rel="icon" sizes="64x64" href="/images/favicon-48.ico"> -->

	<meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="white">
  <meta name="apple-mobile-web-app-title" content="DDStore">
  <!-- <link rel="apple-touch-icon-precomposed" href="/images/favicon-152.png"> -->

	<!-- firebase stuff -->
	<script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
	<script>
  	var config = {
    	apiKey: "AIzaSyD4i89pKORT3k0z60zgMB5O7VIDG12BwzE",
    	authDomain: "ddstore-87442.firebaseapp.com",
    	databaseURL: "https://ddstore-87442.firebaseio.com",
    	projectId: "ddstore-87442",
    	storageBucket: "ddstore-87442.appspot.com",
    	messagingSenderId: "292878095265"
  	};
  	firebase.initializeApp(config);
	</script>
	<script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"></script>
	<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css" />

	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" rel="stylesheet">
  <link href="../css/styles.css" rel="stylesheet">

	<style>
		* {
			--normal-color: #FFF;
			--normal-color-half: rgba(255, 255, 255, 0.5);
			--normal-color-fifth: rgba(255, 255, 255, 0.2);
			--normal-color-tenth: rgba(255, 255, 255, 0.1);
			--normal-background: rgb(41, 58, 74);
			--normal-background-half: rgba(41, 58, 74, 0.5);
			--normal-background-tenth: rgba(41, 58, 74, 0.1);
			--dark-background: rgb(20, 29, 38);
			--dark-background-half: rgba(20, 29, 38, 0.5);
			--accent-color: #82B1FF;
		}

		body {
			background-color: var(--dark-background);
		}

		header {
			background-color: var(--dark-background-half);
		}

		header * {
			color: var(--normal-color);
		}

		#logo {
			position: absolute;
			top: 50%;
			transform: translateY(-50%);
			white-space: nowrap;
			cursor: pointer;
			user-select: none;
		}

		#logo>* {
			font-weight: bolder;
			font-size: 1.75em;
			margin: 0;
			display: inline-block;
			margin-right: 0.5em;
		}

		#logo>img {
			height: 1.5em;
		}

		#logo>h1 {
			position: absolute;
		}

		#signin, #profile {
			display: block;
			position: absolute;
			padding: 0.4em 0.8em;
			top: 50%;
			right: 1.5em;
			cursor: pointer;
			transform: translateY(-50%);

			-moz-transition: background-color .25s;
			-o-transition: background-color .25s;
			-webkit-transition: background-color .25s;
			transition: background-color .25s;
		}

		#profile {
			display: flex;
			align-items: center;
			max-width: calc(50% - 4em);
		}

		#profilePicture {
			width: 3em;
			height: 3em;
			border-radius: 1.5em;
			border: 1px solid #000;
			border: 1px solid var(--normal-color);
		}

		#profileNames {
			display: none;
			margin-right: 1em;
			max-width: calc(100% - 4em);
			text-align: right;
		}

		#profileName {
			font-size: 1em;
		}

		#profileEmail {
			display: none;
			font-size: 0.8em;
		}

		#search {
			display: none;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 50%;
			border: none;
			background-color: rgba(0, 0, 0, 0.1);
			background-color: var(--normal-color-tenth);
			padding: 1em 1.4em;
			border-radius: 0.4em;
		}

		#search::placeholder {
			color: rgba(0, 0, 0, 0.5);
			color: var(--normal-color-half);
			font-weight: bold;
		}

		#info {
			padding: 2em 0;
		}

		#info > div {
			padding: 2em calc(5vw + 1em);
		}

		.inset {
			padding: 1em;
		}

		@media(max-width: 599px) {

			.inset {
				padding: 0;
			}

			.tinycard:not(:last-child) {
				border-color: rgba(255, 255, 255, 0.1) !important;
			}

			.tinycard * {
				color: #FFF;
			}

		}

		@media(min-width: 400px) {
			#profileNames {
				display: block;
			}
		}

		@media(min-width: 700px) {
			#profileEmail {
				display: inline;
			}
		}

		@media(min-width: 900px) {
			#search {
				display: block;
			}

			#profile {
				max-width: calc(25% - 6em);
			}

			#profileEmail {
				display: none;
			}
		}

		@media(min-width: 1200px) {
			#profileEmail {
				display: inline;
			}
		}
	</style>
</head>
<body>
	<header>
		<div id="logo" onclick="setPage('page=home');"><img src="https://doubledotlabs.github.io/images/logo.svg"><h1>Console</h1></div>
		<input id="search" type="text" placeholder="Search for Apps...">
		<button id="signin" class="outline" onclick="location.href='/?page=signin';">
			SIGN IN
		</button>
		<span id="profile" style="display: none;" onclick="location.href='/?page=user';">
			<div id="profileNames">
				<span id="profileName"></span><br>
				<span id="profileEmail"></span>
			</div>
			<img id="profilePicture">
		</span>
	</header>
	<main id="main">
		<div id="info">
			<div>
				<h2>Open-Source Only</h2>
				<p>
					To encourage openness and prevent the spread of malware and adware through devices, our app store only contains open source projects.
					All apps are reviewed by real humans after submission, and their content is verified. Benefits to developers: free resource usage analysis
					and an extra layer of error checking! Benefits to users: less worrying about the integrity of a product and more fun using it!
				</p>
			</div>
			<div>
				<h2>Do No Evil</h2>
				<p>
					Misleading apps are a bad thing, but shutting down a project because of a misunderstanding is unnecessary and stupid.
					When an app submission results in an issue, we don't just tell the developer to go away. Instead, we strive to help fix the issues we find
					in order to help the project achieve success.
				</p>
			</div>
			<div>
				<h2>Plagiarisms Beware</h2>
				<p>
					While it isn't possible to check the entirety of the internet for duplicate code, we do our best to prevent copied or unattributed apps
					from making their way onto our store. We keep documentation of all dependencies our apps use and what license they are published under to
					ensure that no issues occur.
				</p>
			</div>
			<div>
				<h2>But At What Cost?</h2>
				<p>
					As I'm sure you can tell, we have put a lot of work into making this project a success (pro tip: promising success before it's achieved is a
					horrible method of motivation). From the backend magic to our beautiful website
					to our Android app, this project has taken months of planning and development to complete. And it's still not over. However, because all the
					applications on here are free, we don't think it's right for their users to pay to use them or for their developers to pay to publish them.
					That's why we intend to make all our money through donations, advertisements, and paid promotions. As the project expands, we may implement our
					own method of donating to the developers of apps we host that we take a percentage of, but that will come later. Much, much later.
				</p>
			</div>
		</div>
	</main>

	<script type="text/javascript" src="../js/testdata.js"></script>
	<script type="text/javascript" src="../js/utils.js"></script>
	<script type="text/javascript" src="../js/methods.js"></script>
	<script type="text/javascript" src="../js/content.js"></script>
	<script>
		var main = document.getElementById("main");
		var signInElement = document.getElementById("signin");
		var profileElement = document.getElementById("profile");
		var profileNameElement = document.getElementById("profileName");
		var profileEmailElement = document.getElementById("profileEmail");
		var profilePictureElement = document.getElementById("profilePicture");

		var currentUser;
		var isCurrentUserLoading = true;

		function setPage(page, replace) {
			document.body.style.background = null;
			main.style.background = null;
			var shouldScrollTop = true;

			if (!currentUser)
				return;

			var args = page;
			if (typeof page == "string") {
				args = UrlUtils.stringToArguments(page);
			} else page = UrlUtils.argumentsToString(args);

			if (!args.page) {
				args.page = "home";
				page = "?";
			}

			if (args.page == "home") {
				ElementUtils.clearElement(main);

				getUser(currentUser.uid, function(user) {
					main.appendChild(ElementUtils.createElement("<div class=\"inset\">"
						+ ListMethods.grid({}, user.apps, AppMethods.consoleTinyCard)
						+ "</div>"));
				});
			} else if (args.page == "app") {
				ElementUtils.clearElement(main);

				if (args.edit) {
					if (args.edit == "page") {
						getApp(args.package, function(app) {
							document.body.style.background = "url(\"" + app.header + "\") 100% 100% / 9999% 9999% no-repeat fixed";
							main.style.background = "rgb(20, 29, 38)";
							main.appendChild(ElementUtils.createElement("<div class=\"header\" style=\"background: url(\'" + app.header + "\') center / cover no-repeat;\"></div>"));
							main.appendChild(ElementUtils.createElement("<div class=\"appinfo\"><div class=\"appiconinfo\"><img class=\"appicon\" src=\"" + app.icon + "\"></div>"
								+ "<div class=\"appnameinfo\"><h1><div class=\"input long\" contentEditable=\"true\" placeholder=\"App Name\">" + app.name + "</div></h1>"
								+ "<div class=\"input long\" contentEditable=\"true\" placeholder=\"Summary\">" + app.summary + "</div>"
								+ ListMethods.overflow({}, app.links, linksMethod) + "<br><button class=\"outline indented\" style=\"float: right;\">SUBMIT</button></div></div><br>"));
						});
					} else if (args.edit == "releases") {
						//TODO: edit releases
					} else if (args.edit == "description") {
						getApp(args.package, function(app) {
							main.appendChild(ElementUtils.createElement("<div style=\"margin: 2em;\"><h1>Edit Description</h1><div class=\"input long\" contentEditable=\"true\" placeholder=\"Enter a description...\">"
								+ app.description + "</div><button class=\"outline\" style=\"float: right;\">SUBMIT</button></div>"));
						});
					} else {
						setPage("page=404");
						return;
					}
				} else {
					getApp(args.package, function(app) {
						document.body.style.background = "url(\"" + app.header + "\") 100% 100% / 9999% 9999% no-repeat fixed";
						main.style.background = "rgb(20, 29, 38)";
						main.appendChild(ElementUtils.createElement("<div class=\"header\" style=\"background: url(\'" + app.header + "\') center / cover no-repeat;\"></div>"));
						main.appendChild(ElementUtils.createElement("<div class=\"appinfo\"><div class=\"appiconinfo\"><img class=\"appicon\" src=\"" + app.icon + "\"><button class=\"outline\" onclick=\"setPage(\'page=app&package=" + app.package + "&edit=page\');\">EDIT PAGE</button></div>"
							+ "<div class=\"appnameinfo\"><h1>" + app.name + "</h1><p>" + app.summary + "</p>"
							+ ListMethods.overflow({}, app.links, linksMethod) + "</div></div>"));

						main.appendChild(ElementUtils.createElement("<hr><h1 class=\"indented\">Current Release: " + app.releases[0].version + "</h1><h3 class=\"indented\">Last updated " + app.releases[0].date + "</h3>"
						 	+ ListMethods.grid({}, app.releases[0].downloads, DownloadMethods.console)
							+ "<a class=\"indented\" href=\"javascript:setPage(\'page=releases&package=" + args.package + "\');\"><i class=\"material-icons\">open_in_new</i>ALL RELEASES</a>"
							+ "<a class=\"indented\" href=\"javascript:setPage(\'page=releases&package=" + args.package + "&edit=new\');\"><i class=\"material-icons\">add</i>NEW RELEASE</a><br><br><br>"
							+ "<h3 class=\"indented\">Changelog<a style=\"font-size: 0.855em; font-weight: normal; float: right;\" href=\"javascript:setPage(\'page=releases&package=" + args.package + "&version=" + app.releases[0].version + "&edit=changelog\');\"><i class=\"material-icons\">edit</i>EDIT</a></h3>"
							+ "<div class=\"appdesc\">" + app.releases[0].notes.split("\n").join("<br>") + "</div><hr>"));

						main.appendChild(ElementUtils.createElement("<div class=\"appdesc\"><p>" + app.description + "</p><a class=\"link\" href=\"javascript:setPage(\'page=app&package=" + app.package + "&edit=description\')\"><i class=\"material-icons\">edit</i>EDIT DESCRIPTION</a></div>"));

						main.appendChild(ElementUtils.createElement(ListMethods.grid({"name": "Reviews"}, app.reviews, ReviewMethods.console)));
						main.appendChild(ElementUtils.createElement("<a class=\"indented\" href=\"javascript:setPage(\'page=reviews&package=" + app.package + "\');\"><i class=\"material-icons\">open_in_new</i>All Reviews</a><br><br><br>"));
					});
				}
			} else if (args.page == "reviews") {
				ElementUtils.clearElement(main);

				if (args.id) {
					getReview(args.id, function(review) {
						main.appendChild(ElementUtils.createElement("<div class=\"single\">" + ReviewMethods.console(review) + "</div>"));
					});
				} else {
					getReviews(args.package, function(reviews) {
						main.appendChild(ElementUtils.createElement("<div class=\"single\">" + ListMethods.grid({"name": "Reviews"}, reviews, ReviewMethods.console) + "</div>"));
					});
				}
			} else if (args.page == "releases") {
				ElementUtils.clearElement(main);

				if (args.version) {
					if (args.edit) {
						getApp(args.package, function(app) {
							var release = null;
							for (var i = 0; i < app.releases.length; i++) {
								if (args.version == app.releases[i].version) {
									release = app.releases[i];
									break;
								}
							}

							//TODO: edit release
							main.appendChild(ElementUtils.createElement("<div style=\"margin: 1em;\">"
								+ "<h1 class=\"indented\">Release: " + app.releases[i].version + "</h1><h3 class=\"indented\">Published on " + app.releases[i].date + "</h3>"
								+ ListMethods.grid({}, app.releases[i].downloads, DownloadMethods.console)
								+ "<h3 class=\"indented\">Changelog</h3>"
								+ "<div style=\"padding: 1em 2em;\"><div class=\"input long\" contentEditable=\"true\" placeholder=\"Changelog\">" + app.releases[i].notes.split("\n").join("<br>") + "</div></div>"
								+ "</div>"));
						});
					} else {
						getApp(args.package, function(app) {
							var release = null;
							for (var i = 0; i < app.releases.length; i++) {
								if (args.version == app.releases[i].version) {
									release = app.releases[i];
									break;
								}
							}

							main.appendChild(ElementUtils.createElement("<div style=\"margin: 1em;\">"
								+ "<h1 class=\"indented\">Release: " + app.releases[i].version + "</h1><h3 class=\"indented\">Published on " + app.releases[i].date + "</h3>"
								+ ListMethods.grid({}, app.releases[i].downloads, DownloadMethods.console)
								+ "<h3 class=\"indented\">Changelog<a style=\"font-size: 0.855em; font-weight: normal; float: right;\" href=\"javascript:setPage(\'page=releases&package=" + args.package + "&version=" + app.releases[i].version + "&edit=changelog\');\"><i class=\"material-icons\">edit</i>EDIT</a></h3>"
								+ "<div style=\"padding: 1em 2em;\">" + app.releases[i].notes.split("\n").join("<br>") + "</div>"
								+ "</div>"));
						});
					}
				} else if (args.edit == "new") {
					//TODO: new release
				} else {
					getApp(args.package, function(app) {
						var html = "";
						for (var i = 0; i < app.releases.length; i++) {
							html += "<hr><h1 class=\"indented\">Release: " + app.releases[i].version + "</h1><h3 class=\"indented\">Published on " + app.releases[i].date + "</h3>"
							 	+ ListMethods.grid({}, app.releases[i].downloads, DownloadMethods.console)
								+ "<h3 class=\"indented\">Changelog<a style=\"font-size: 0.855em; font-weight: normal; float: right;\" href=\"javascript:setPage(\'page=releases&package=" + args.package + "&version=" + app.releases[i].version + "&edit=changelog\');\"><i class=\"material-icons\">edit</i>EDIT</a></h3>"
								+ "<div style=\"padding: 1em 2em;\">" + app.releases[i].notes.split("\n").join("<br>") + "</div>";
						}

						main.appendChild(ElementUtils.createElement("<div style=\"margin: 1em;\">" + html.substring(4) + "</div>"));
					});
				}
			}

			if (replace)
				window.history.replaceState({}, "", page ? "?" + page : "?");
			else {
				window.history.pushState({}, "", page ? "?" + page : "?");
				if (shouldScrollTop)
					window.scrollTo(0, 0);
			}
		}

		setPage(UrlUtils.getCurrentArguments(), true);

		window.onpopstate = function() {
			setPage(UrlUtils.getCurrentArguments(), true);
			console.log("h");
		}

		window.addEventListener("load", function() {
			firebase.auth().onAuthStateChanged(function(user) {
				currentUser = user;
				isCurrentUserLoading = false;

				if (user) {
					signInElement.style.display = "none";
					profileElement.style.display = null;

					profileNameElement.innerHTML = user.displayName;
					profileEmailElement.innerHTML = user.email;
					profilePictureElement.src = user.photoURL;

					setPage(UrlUtils.getCurrentArguments(), true);
				} else {
					profileElement.style.display = "none";
					signInElement.style.display = null;
				}
			}, function(error) {
				isCurrentUserLoading = false;
				console.error("Sign In Error", error);
				//TODO: 404 page
			});
		});
	</script>
</body>
</html>
